datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String            @id @default(cuid())
  email         String            @unique
  name          String
  password      String
  avatar        String?
  isAdmin       Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  messages            Message[]
  groups              GroupMember[]
  createdGroups       Group[]                   @relation("GroupAdmin")
  readMessages        MessageRead[]
  reactions           MessageReaction[]
  mentions            Mention[]
  notificationPrefs   NotificationPreferences[]
  initiatedCalls      Call[]                    @relation("CallInitiator")
  callParticipants    CallParticipant[]
}

model Group {
  id          String        @id @default(cuid())
  name        String
  description String?
  avatar      String?
  isOneToOne  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  adminId     String
  admin       User          @relation("GroupAdmin", fields: [adminId], references: [id])
  
  members               GroupMember[]
  messages              Message[]
  notificationPrefs     NotificationPreferences[]
  calls                 Call[]
}

model GroupMember {
  id        String   @id @default(cuid())
  joinedAt  DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}

model Call {
  id                String            @id @default(cuid())
  type              String            // video, audio
  status            String            @default("initiated") // initiated, ringing, active, ended, missed, rejected
  startedAt         DateTime          @default(now())
  endedAt           DateTime?
  duration          Int?              // duration in seconds
  isGroupCall       Boolean           @default(false)
  recordingUrl      String?
  quality           String?           // excellent, good, fair, poor
  
  initiatorId       String
  initiator         User              @relation("CallInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  
  groupId           String?
  group             Group?            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  participants      CallParticipant[]
  
  @@index([initiatorId])
  @@index([groupId])
  @@index([status])
  @@index([startedAt])
}

model CallParticipant {
  id            String    @id @default(cuid())
  joinedAt      DateTime  @default(now())
  leftAt        DateTime?
  status        String    @default("invited") // invited, joined, left, rejected
  
  callId        String
  call          Call      @relation(fields: [callId], references: [id], onDelete: Cascade)
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([callId, userId])
  @@index([callId])
  @@index([userId])
}

model Message {
  id          String            @id @default(cuid())
  content     String
  type        String            @default("text") // text, voice, image, file
  fileUrl     String?
  fileName    String?
  fileType    String?
  createdAt   DateTime          @default(now())
  isPriority  Boolean           @default(false)
  hasMentions Boolean           @default(false)
  
  senderId  String
  sender    User              @relation(fields: [senderId], references: [id])
  
  groupId   String
  group     Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  replyToId String?
  replyTo   Message?          @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[]         @relation("MessageReplies")
  
  readBy    MessageRead[]
  reactions MessageReaction[]
  mentions  Mention[]
}

model MessageRead {
  id        String   @id @default(cuid())
  readAt    DateTime @default(now())
  
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId])
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  otp       String
  createdAt DateTime @default(now())
  expiresAt DateTime
  verified  Boolean  @default(false)
  
  @@index([email])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)
  
  @@index([email])
  @@index([token])
}

model MessageReaction {
  id        String   @id @default(cuid())
  emoji     String
  createdAt DateTime @default(now())
  
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Mention {
  id         String   @id @default(cuid())
  startIndex Int
  length     Int
  isAll      Boolean  @default(false) // true for @all mentions
  createdAt  DateTime @default(now())
  
  messageId  String
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  userId     String?  // null for @all
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([userId])
}

model NotificationPreferences {
  id                String    @id @default(cuid())
  sound             String    @default("default") // default, pop, chime, bell, none
  showPreview       Boolean   @default(true)
  isPriority        Boolean   @default(false)
  muteUntil         DateTime?
  onlyMentions      Boolean   @default(false)
  bundleMessages    Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groupId           String
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
}
